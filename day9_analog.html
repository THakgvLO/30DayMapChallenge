<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Global DEM Analog Map - Oil Pastel Style</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <style>
      html,
      body,
      #map {
        padding: 0;
        margin: 0;
        height: 100%;
        width: 100%;
      }

      #controls {
        position: absolute;
        top: 75px;
        left: 10px;
        background: white;
        padding: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        z-index: 1000;
        font-family: sans-serif;
        border-radius: 5px;
        max-width: 320px;
      }

      #opacityLabel {
        margin-top: 8px;
        display: block;
        font-weight: bold;
      }

      #demOpacityLabel {
        margin-top: 12px;
        display: block;
        font-weight: bold;
      }

      #instructions {
        margin-top: 8px;
        font-size: 12px;
      }

      /* Oil pastel purple DEM styling */
      .purple-dem-layer {
        mix-blend-mode: overlay;
        filter: saturate(1.4) contrast(1.15);
      }

      canvas.purple-dem-layer {
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
      }
    </style>
  </head>

  <body>
    <div id="controls">
      <h3>Global DEM - Oil Pastel Map</h3>
      
      <label id="opacityLabel" for="opacityRange">Watercolor Map Opacity:</label>
      <input
        type="range"
        id="opacityRange"
        min="0"
        max="1"
        step="0.01"
        value="0.7"
      />

      <label id="demOpacityLabel" for="demOpacityRange">Purple DEM Intensity:</label>
      <input
        type="range"
        id="demOpacityRange"
        min="0"
        max="1"
        step="0.01"
        value="0.75"
      />
      
      <div id="instructions">
        <strong>Global coverage.</strong> Pan and zoom anywhere in the world. The purple DEM elevation overlay uses Mapbox Terrain RGB tiles with oil pastel styling.
        <br><br>
        <em>Base: Stamen Watercolor | DEM: Terrarium Tiles</em>
      </div>
    </div>
    <div id="map"></div>

    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <script>
      // --- Global Map Setup ---
      
      // Hand-drawn watercolor style map base
      const watercolorBase = L.tileLayer('https://tiles.stadiamaps.com/tiles/stamen_watercolor/{z}/{x}/{y}.jpg', {
          maxZoom: 16,
          opacity: 0.7,
          attribution: 'Base: Stamen Watercolor'
      });

      // Analog topo overlay (can be toggled)
      const topoOverlay = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}', {
          maxZoom: 19,
          opacity: 0,
          attribution: 'Topo: Esri'
      });

      // Initialize map - start at global view
      const map = L.map("map", {
          center: [20, 0], // Global center
          zoom: 3,
          layers: [watercolorBase],
          maxZoom: 15
      });
      
      // Add a simple base layer underneath watercolor
      const simpleBase = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Â© OpenStreetMap'
      });
      simpleBase.addTo(map);
      simpleBase.bringToBack();

      // --- Custom Purple DEM Layer using Mapbox Terrain-RGB ---
      
      const PurpleDEMLayer = L.GridLayer.extend({
        createTile: function(coords, done) {
          const tile = document.createElement('canvas');
          const ctx = tile.getContext('2d');
          const size = this.getTileSize();
          tile.width = size.x;
          tile.height = size.y;

          // Using Mapzen/Tilezen Terrain Tiles (open source, no token needed)
          const url = `https://s3.amazonaws.com/elevation-tiles-prod/terrarium/${coords.z}/${coords.x}/${coords.y}.png`;

          const img = new Image();
          img.crossOrigin = 'anonymous';
          
          img.onload = () => {
            ctx.drawImage(img, 0, 0);
            const imageData = ctx.getImageData(0, 0, size.x, size.y);
            const data = imageData.data;

            // Decode Mapbox Terrain-RGB format and apply purple oil pastel colors
            for (let i = 0; i < data.length; i += 4) {
              const r = data[i];
              const g = data[i + 1];
              const b = data[i + 2];

              // Terrarium format: height = (R * 256 + G + B / 256) - 32768
              const height = (r * 256 + g + b / 256) - 32768;
              
              // Normalize height for color mapping (sea level to ~6000m)
              const normalized = Math.max(0, Math.min(1, (height + 500) / 6500));
              
              // Oil pastel purple gradient
              const purpleIntensity = Math.pow(normalized, 0.6);
              
              // Deep violet (low) to bright magenta (high)
              const newR = Math.floor(100 + purpleIntensity * 155);
              const newG = Math.floor(purpleIntensity * 30);
              const newB = Math.floor(180 + purpleIntensity * 75);
              
              // Apply purple color
              data[i] = newR;
              data[i + 1] = newG;
              data[i + 2] = newB;
              // Keep original alpha for transparency
            }

            ctx.putImageData(imageData, 0, 0);
            done(null, tile);
          };

          img.onerror = () => {
            done(new Error('Failed to load tile'), tile);
          };

          img.src = url;
          
          return tile;
        }
      });

      // Add the purple DEM layer
      const purpleDEM = new PurpleDEMLayer({
        opacity: 0.75,
        className: 'purple-dem-layer'
      });
      purpleDEM.addTo(map);

      // --- Controls ---
      
      // Watercolor base opacity
      const opacitySlider = document.getElementById("opacityRange");
      opacitySlider.addEventListener("input", (e) => {
        watercolorBase.setOpacity(parseFloat(e.target.value));
      });

      // Purple DEM intensity
      const demOpacitySlider = document.getElementById("demOpacityRange");
      demOpacitySlider.addEventListener("input", (e) => {
        purpleDEM.setOpacity(parseFloat(e.target.value));
      });

    </script>
  </body>
</html>